# ゲストはメールアドレスとパスワードを使ってユーザー登録できる

## ユーザーストーリー

**As a** ゲスト（未登録の利用者）  
**I want** メールアドレスとパスワードを使ってユーザー登録できる  
**So that** システムにログインしてCVの管理機能を利用できる

## 概要

ゲストがmanagerサービスを利用するために、メールアドレスとパスワードを使用してユーザー登録を行う機能を提供します。登録が完了すると、ユーザーとしてシステムにログインし、CV管理機能にアクセスできるようになります。

## 受け入れ基準（Acceptance Criteria）

### 1. ユーザー登録フォームの表示

**WHEN** ゲストがユーザー登録ページにアクセスする  
**THEN** システムは以下の入力フィールドを含む登録フォームを表示する
- メールアドレス入力フィールド
- パスワード入力フィールド
- パスワード確認入力フィールド
- 登録ボタン

### 2. メールアドレスのバリデーション

**WHEN** ゲストがメールアドレスを入力する  
**THEN** システムはメールアドレスの形式が正しいことを検証する

**IF** メールアドレスの形式が不正である  
**THEN** システムは「メールアドレスの形式が正しくありません」というエラーメッセージを表示する

### 3. パスワードのバリデーション

**WHEN** ゲストがパスワードを入力する  
**THEN** システムは以下の条件を満たすことを検証する
- パスワードが8文字以上である
- パスワードに英字と数字が含まれている

**IF** パスワードが条件を満たさない  
**THEN** システムは「パスワードは8文字以上で、英字と数字を含む必要があります」というエラーメッセージを表示する

### 4. パスワード確認の一致検証

**WHEN** ゲストがパスワードとパスワード確認を入力する  
**THEN** システムは両方のパスワードが一致することを検証する

**IF** パスワードが一致しない  
**THEN** システムは「パスワードが一致しません」というエラーメッセージを表示する

### 5. メールアドレスの重複チェック

**WHEN** ゲストが登録ボタンをクリックする  
**THEN** システムは入力されたメールアドレスが既に登録されていないことを確認する

**IF** メールアドレスが既に登録されている  
**THEN** システムは「このメールアドレスは既に登録されています」というエラーメッセージを表示する

### 6. メール確認の送信

**WHEN** ゲストが有効な情報を入力して登録ボタンをクリックする  
**AND** すべてのバリデーションが成功する  
**THEN** システムは以下の処理を実行する
- 確認トークンを生成する（有効期限付き）
- 確認トークンを一時的に保存する
- 入力されたメールアドレス宛に確認メールを送信する
- 確認メールには確認用のURLを含める

**WHEN** 確認メールの送信が完了する  
**THEN** システムは「確認メールを送信しました。メールに記載されたリンクをクリックして登録を完了してください」というメッセージを表示する

### 7. メール確認リンクのクリック

**WHEN** ゲストが確認メール内のリンクをクリックする  
**THEN** システムは確認トークンの有効性を検証する

**IF** 確認トークンが有効である  
**THEN** システムはユーザー登録処理を続行する

**IF** 確認トークンが無効または期限切れである  
**THEN** システムは「確認リンクが無効または期限切れです。再度登録をお試しください」というエラーメッセージを表示する

### 8. ユーザー登録の実行

**WHEN** メール確認が完了する  
**THEN** システムは以下の処理を実行する
- パスワードをハッシュ化して保存する
- 新しいユーザーレコードをデータベースに作成する
- ユーザーIDを生成する
- 作成日時を記録する
- 確認トークンを削除する

### 9. 登録成功時の処理

**WHEN** ユーザー登録が正常に完了する  
**THEN** システムは以下の処理を実行する
- 認証トークンを生成する
- ユーザーを自動的にログイン状態にする
- ダッシュボードページにリダイレクトする
- 「登録が完了しました」という成功メッセージを表示する

### 10. メール送信失敗時のエラーハンドリング

**IF** 確認メールの送信に失敗する  
**THEN** システムは「メールの送信に失敗しました。しばらくしてから再度お試しください」というエラーメッセージを表示する

### 11. 登録失敗時のエラーハンドリング

**IF** データベースエラーやその他の予期しないエラーが発生する  
**THEN** システムは「登録処理中にエラーが発生しました。しばらくしてから再度お試しください」というエラーメッセージを表示する

### 12. セキュリティ要件

**WHEN** システムがパスワードを保存する  
**THEN** システムはパスワードを平文で保存せず、必ずハッシュ化して保存する

**WHEN** システムがユーザー登録APIを提供する  
**THEN** システムはCSRF攻撃を防ぐための対策を実装する

**WHEN** システムが確認トークンを生成する  
**THEN** システムは推測困難なランダムなトークンを生成し、有効期限を設定する

### 13. レスポンシブデザイン

**WHEN** ゲストがモバイルデバイスから登録ページにアクセスする  
**THEN** システムはモバイル画面に最適化されたレイアウトで登録フォームを表示する

## 技術的な制約

- パスワードのハッシュ化にはbcryptまたは同等のアルゴリズムを使用する
- メールアドレスはデータベースでユニーク制約を設定する
- ユーザーIDはUUID v4形式で生成する
- 認証トークンはJWT形式で生成する
- 確認トークンはUUID v4形式で生成し、有効期限は24時間とする
- メール送信には適切なSMTPサービスまたはメール送信APIを使用する

## 非機能要件

- 確認メールの送信処理は5秒以内に完了する
- ユーザー登録処理（メール確認後）は3秒以内に完了する
- 登録フォームはアクセシビリティ基準（WCAG 2.1 AA）に準拠する
- すべてのバリデーションエラーは明確で理解しやすいメッセージで表示する
- 確認メールは日本語で記載され、わかりやすい内容とする

## 関連するユビキタス言語

- **ゲスト（guest）**: まだユーザー登録していない利用者
- **ユーザー（user）**: ユーザー登録が済んだ利用者
- **manager**: WebエンジニアのCVを管理するサービス
- **確認トークン（verification token）**: メールアドレスの所有権を確認するための一時的なトークン

## 備考

- この機能はmanagerサービスのフロントエンドとバックエンドの両方で実装が必要
- 将来的にはGoogle OAuth 2.0によるソーシャルログインも追加予定だが、このユーザーストーリーではメールアドレス/パスワードによる登録のみを対象とする
- メール確認プロセスにより、メールアドレスの存在確認と所有権の検証を行う
- 確認トークンは一時的なデータとして保存し、メール確認完了後は削除する
- 確認メールには、登録を完了するためのリンクと有効期限（24時間）を明記する
