# ゲストはメールアドレスとパスワードを使ってユーザー登録できる

## ユーザーストーリー

**As a** ゲスト（未登録の利用者）  
**I want** メールアドレスとパスワードを使ってユーザー登録できる  
**So that** システムにログインしてCVの管理機能を利用できる

## 概要

ゲストがmanagerサービスを利用するために、メールアドレスとパスワードを使用してユーザー登録を行う機能を提供します。登録が完了すると、ユーザーとしてシステムにログインし、CV管理機能にアクセスできるようになります。

## 受け入れ基準（Acceptance Criteria）

### 1. ユーザー登録フォームの表示

**WHEN** ゲストがユーザー登録ページにアクセスする  
**THEN** システムは以下の入力フィールドを含む登録フォームを表示する
- メールアドレス入力フィールド
- パスワード入力フィールド
- パスワード確認入力フィールド
- 登録ボタン

### 2. メールアドレスのバリデーション

**WHEN** ゲストがメールアドレスを入力する  
**THEN** システムはメールアドレスの形式が正しいことを検証する

**IF** メールアドレスの形式が不正である  
**THEN** システムは「メールアドレスの形式が正しくありません」というエラーメッセージを表示する

### 3. パスワードのバリデーション

**WHEN** ゲストがパスワードを入力する  
**THEN** システムは以下の条件を満たすことを検証する
- パスワードが8文字以上である
- パスワードに英字と数字が含まれている

**IF** パスワードが条件を満たさない  
**THEN** システムは「パスワードは8文字以上で、英字と数字を含む必要があります」というエラーメッセージを表示する

### 4. パスワード確認の一致検証

**WHEN** ゲストがパスワードとパスワード確認を入力する  
**THEN** システムは両方のパスワードが一致することを検証する

**IF** パスワードが一致しない  
**THEN** システムは「パスワードが一致しません」というエラーメッセージを表示する

### 5. メールアドレスの重複チェック

**WHEN** ゲストが登録ボタンをクリックする  
**THEN** システムは入力されたメールアドレスが既に登録されていないことを確認する

**IF** メールアドレスが既に登録されている  
**THEN** システムは「このメールアドレスは既に登録されています」というエラーメッセージを表示する

### 6. メール確認の送信

**WHEN** ゲストが有効な情報を入力して登録ボタンをクリックする  
**AND** すべてのバリデーションが成功する  
**THEN** システムは以下の処理を実行する
- 確認トークンを生成する（有効期限付き）
- 確認トークンを一時的に保存する
- 入力されたメールアドレス宛に確認メールを送信する
- 確認メールには確認用のURLを含める

**WHEN** 確認メールの送信が完了する  
**THEN** システムは「確認メールを送信しました。メールに記載されたリンクをクリックして登録を完了してください」というメッセージを表示する

### 7. メール確認リンクのクリック

**WHEN** ゲストが確認メール内のリンクをクリックする  
**THEN** システムは確認トークンの有効性を検証する

**IF** 確認トークンが有効である  
**THEN** システムはユーザー登録処理を続行する

**IF** 確認トークンが無効または期限切れである  
**THEN** システムは「確認リンクが無効または期限切れです。再度登録をお試しください」というエラーメッセージを表示する

### 8. ユーザー登録の実行

**WHEN** メール確認が完了する  
**THEN** システムは以下の処理を実行する
- UUID v7形式でユーザーIDを生成する
- パスワードをbcryptでハッシュ化して保存する
- 新しいユーザーレコードをデータベースに作成する
- created_at、updated_atをUTCの現在時刻で記録する
- email_verified_atをUTCの現在時刻で記録する
- is_activeを1（有効）に設定する
- 確認トークンを削除する

### 9. 登録成功時の処理

**WHEN** ユーザー登録が正常に完了する  
**THEN** システムは以下の処理を実行する
- 認証トークンを生成する
- ユーザーを自動的にログイン状態にする
- ダッシュボードページにリダイレクトする
- 「登録が完了しました」という成功メッセージを表示する

### 10. メール送信失敗時のエラーハンドリング

**IF** 確認メールの送信に失敗する  
**THEN** システムは「メールの送信に失敗しました。しばらくしてから再度お試しください」というエラーメッセージを表示する

### 11. 登録失敗時のエラーハンドリング

**IF** データベースエラーやその他の予期しないエラーが発生する  
**THEN** システムは「登録処理中にエラーが発生しました。しばらくしてから再度お試しください」というエラーメッセージを表示する

### 12. セキュリティ要件

**WHEN** システムがパスワードを保存する  
**THEN** システムはパスワードを平文で保存せず、必ずハッシュ化して保存する

**WHEN** システムがユーザー登録APIを提供する  
**THEN** システムはCSRF攻撃を防ぐための対策を実装する

**WHEN** システムが確認トークンを生成する  
**THEN** システムは推測困難なランダムなトークンを生成し、有効期限を設定する

### 13. レスポンシブデザイン

**WHEN** ゲストがモバイルデバイスから登録ページにアクセスする  
**THEN** システムはモバイル画面に最適化されたレイアウトで登録フォームを表示する

## 技術的な制約

### バックエンド技術スタック
- パスワードのハッシュ化にはbcryptを使用する（Golang標準の実装）
- メールアドレスはデータベースでユニーク制約を設定する
- ユーザーIDはUUID v7形式で生成し、BINARY(16)で保存する
- 認証トークンはJWT形式で生成する（golang.org/x/oauth2を使用）
- 確認トークンはUUID v7形式で生成し、有効期限は24時間とする
- メール送信には適切なSMTPサービスまたはメール送信APIを使用する
- 日時はすべてUTCで保存し、DATETIME(6)型を使用する（マイクロ秒精度）
- データベースの文字コードはutf8mb4、照合順序はutf8mb4_unicode_ciを使用する

### データベーススキーマ要件

**usersテーブル**:
- `id` BINARY(16) PRIMARY KEY - UUID v7
- `email` VARCHAR(255) NOT NULL UNIQUE - メールアドレス
- `password_hash` VARCHAR(255) NOT NULL - bcryptハッシュ
- `name` VARCHAR(100) - ユーザー名（オプション、登録時は空でも可）
- `bio` TEXT - 自己紹介（オプション）
- `is_active` TINYINT(1) NOT NULL DEFAULT 1 - アクティブ状態
- `email_verified_at` DATETIME(6) - メール確認日時
- `last_login_at` DATETIME(6) - 最終ログイン日時
- `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
- `updated_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)
- `deleted_at` DATETIME(6) - 論理削除用

**email_verification_tokensテーブル**:
- `id` BINARY(16) PRIMARY KEY - UUID v7
- `user_email` VARCHAR(255) NOT NULL - 確認対象のメールアドレス
- `token` VARCHAR(255) NOT NULL UNIQUE - 確認トークン（UUID v7）
- `expires_at` DATETIME(6) NOT NULL - 有効期限
- `created_at` DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
- INDEX on `token` for fast lookup
- INDEX on `expires_at` for cleanup queries

### フロントエンド技術スタック
- React 18+ with TypeScript
- TanStack Router for routing
- TanStack Query for data fetching
- React Hook Form + Zod for form validation
- Jotai for global state management
- ky for HTTP client
- shadcn/ui for UI components

## 非機能要件

- 確認メールの送信処理は5秒以内に完了する
- ユーザー登録処理（メール確認後）は3秒以内に完了する
- 登録フォームはアクセシビリティ基準（WCAG 2.1 AA）に準拠する
- すべてのバリデーションエラーは明確で理解しやすいメッセージで表示する
- 確認メールは日本語で記載され、わかりやすい内容とする
- APIエラーレスポンスは統一されたフォーマット（requestId、code、details）で返す
- ログはCloudLogging形式のJSON構造化ログとして出力する
- ログにはcontext由来のrequest_idを自動付与する

## 関連するユビキタス言語

- **ゲスト（guest）**: まだユーザー登録していない利用者
- **ユーザー（user）**: ユーザー登録が済んだ利用者
- **manager**: WebエンジニアのCVを管理するサービス
- **確認トークン（verification token）**: メールアドレスの所有権を確認するための一時的なトークン

## アーキテクチャ上の考慮事項

### バックエンド（Clean Architecture + DDD + CQRS）

- **Domain層**: User集約、Email値オブジェクト、Password値オブジェクトを定義
- **UseCase層**: RegisterUserコマンド、VerifyEmailコマンドを実装
- **Adapter層**: HTTPハンドラーでリクエスト/レスポンスを変換
- **Infrastructure層**: sqlcを使用したリポジトリ実装、メール送信サービス
- **CQRS**: ユーザー登録はコマンド側で実装（集約を使用）
- **トランザクション**: User集約の保存は単一トランザクションで実行
- **バリデーション**: 型レベルのバリデーションはOpenAPI、ドメインルールはDomain層で検証

### フロントエンド（レイヤードアーキテクチャ）

- **Presentation層**: 登録ページコンポーネント、フォームコンポーネント
- **Application層**: useRegisterUser Hook（TanStack Query）、useUserForm Hook（React Hook Form + Zod）
- **Domain層**: ユーザー型定義、バリデーションルール
- **Infrastructure層**: APIクライアント（ky）、OpenAPI生成コード
- **状態管理**: 認証状態はJotaiで管理、フォーム状態はReact Hook Formで管理

## 備考

- この機能はmanagerサービスのフロントエンドとバックエンドの両方で実装が必要
- 将来的にはGoogle OAuth 2.0によるソーシャルログインも追加予定だが、このユーザーストーリーではメールアドレス/パスワードによる登録のみを対象とする
- メール確認プロセスにより、メールアドレスの存在確認と所有権の検証を行う
- 確認トークンは一時的なデータとして保存し、メール確認完了後は削除する
- 確認メールには、登録を完了するためのリンクと有効期限（24時間）を明記する
- データベーススキーマはsqldefでマイグレーション管理する
- SQLクエリはsqlcで型安全なGoコードを生成する
- APIエンドポイントは `/techcv/api/v1/auth/register` および `/techcv/api/v1/auth/verify` とする
